# Template API Testing Examples

## 🎯 Template Management via API

### 1. สร้าง Template ตัวอย่างผ่าน Tinker

```php
php artisan tinker

// สร้าง template สำหรับ Welcome Email
$welcomeTemplate = App\Models\NotificationTemplate::create([
    'name' => 'Welcome New User',
    'description' => 'Welcome email for new users',
    'category' => 'welcome',
    'slug' => 'welcome-new-user',
    'subject_template' => 'Welcome to {{company}}, {{user_name}}!',
    'body_html_template' => '
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background: #4CAF50; color: white; padding: 20px; text-align: center;">
                <h1>Welcome to {{company}}! 🎉</h1>
            </div>
            <div style="padding: 30px;">
                <h2>Hello {{user_name}},</h2>
                <p>We are excited to have you join our team in the <strong>{{department}}</strong> department!</p>
                
                {{#if is_manager}}
                <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 20px 0;">
                    <h3>👥 Manager Resources</h3>
                    <p>As a manager, you have access to additional tools and resources.</p>
                </div>
                {{/if}}
                
                <h3>📋 Your Details:</h3>
                <ul>
                    <li><strong>Email:</strong> {{user_email}}</li>
                    <li><strong>Department:</strong> {{department}}</li>
                    <li><strong>Start Date:</strong> {{date:Y-m-d|start_date}}</li>
                </ul>
                
                {{#if next_steps}}
                <h3>🚀 Next Steps:</h3>
                <ol>
                {{#each next_steps}}
                    <li>{{this}}</li>
                {{/each}}
                </ol>
                {{/if}}
                
                <p>If you have any questions, please contact HR at {{hr_email}} or call {{hr_phone}}.</p>
                
                <div style="margin-top: 30px; text-align: center;">
                    <a href="{{login_url}}" style="background: #4CAF50; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px;">
                        Login to Your Account
                    </a>
                </div>
            </div>
            <div style="background: #f5f5f5; padding: 20px; text-align: center; font-size: 12px; color: #666;">
                Welcome to {{company}} | {{current_date}}
            </div>
        </div>
    ',
    'body_text_template' => '
Welcome to {{company}}, {{user_name}}!

Hello {{user_name}},

We are excited to have you join our team in the {{department}} department!

{{#if is_manager}}
As a manager, you have access to additional tools and resources.
{{/if}}

Your Details:
- Email: {{user_email}}
- Department: {{department}}
- Start Date: {{date:Y-m-d|start_date}}

{{#if next_steps}}
Next Steps:
{{#each next_steps}}
{{this}}
{{/each}}
{{/if}}

If you have any questions, please contact HR at {{hr_email}} or call {{hr_phone}}.

Login URL: {{login_url}}

Welcome to {{company}} | {{current_date}}
    ',
    'variables' => [
        'user_name', 'user_email', 'department', 'start_date', 
        'hr_email', 'hr_phone', 'login_url'
    ],
    'default_variables' => [
        'company' => 'SAM Organization',
        'hr_email' => 'hr@sam.or.th',
        'hr_phone' => '02-123-4567'
    ],
    'supported_channels' => ['email', 'teams'],
    'priority' => 'medium',
    'is_active' => true,
    'created_by' => 1
]);

echo "Welcome template created with ID: " . $welcomeTemplate->id . "\n";

// สร้าง template สำหรับ System Alert
$alertTemplate = App\Models\NotificationTemplate::create([
    'name' => 'System Alert',
    'description' => 'Template for system alerts and maintenance notifications',
    'category' => 'alert',
    'slug' => 'system-alert',
    'subject_template' => '[{{priority}}] {{alert_type}}: {{subject}}',
    'body_html_template' => '
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background: {{#if is_urgent}}#f44336{{else}}#ff9800{{/if}}; color: white; padding: 20px;">
                <h1>🚨 System Alert</h1>
                <p style="margin: 0; font-size: 18px;">{{alert_type}}</p>
            </div>
            <div style="padding: 30px;">
                <h2>{{subject}}</h2>
                <p><strong>Priority:</strong> {{priority}}</p>
                <p><strong>Affected Systems:</strong> {{affected_systems}}</p>
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 20px 0;">
                    <h3>📋 Details:</h3>
                    <p>{{message}}</p>
                </div>
                
                {{#if maintenance_window}}
                <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 20px 0;">
                    <h3>🔧 Maintenance Window:</h3>
                    <p><strong>Start:</strong> {{date:Y-m-d H:i|maintenance_start}}</p>
                    <p><strong>End:</strong> {{date:Y-m-d H:i|maintenance_end}}</p>
                    <p><strong>Duration:</strong> {{maintenance_duration}}</p>
                </div>
                {{/if}}
                
                {{#if contact_info}}
                <div style="margin-top: 30px;">
                    <h3>📞 Contact Information:</h3>
                    <p>For questions or support, contact:</p>
                    <ul>
                    {{#each contact_info}}
                        <li><strong>{{this.role}}:</strong> {{this.name}} - {{this.email}}</li>
                    {{/each}}
                    </ul>
                </div>
                {{/if}}
                
                <div style="margin-top: 30px; text-align: center;">
                    <a href="{{status_url}}" style="background: #2196F3; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px;">
                        Check System Status
                    </a>
                </div>
            </div>
            <div style="background: #f5f5f5; padding: 20px; text-align: center; font-size: 12px; color: #666;">
                Alert ID: {{alert_id}} | {{current_datetime}}
            </div>
        </div>
    ',
    'body_text_template' => '
🚨 SYSTEM ALERT: {{alert_type}}

Subject: {{subject}}
Priority: {{priority}}
Affected Systems: {{affected_systems}}

Details:
{{message}}

{{#if maintenance_window}}
Maintenance Window:
- Start: {{date:Y-m-d H:i|maintenance_start}}
- End: {{date:Y-m-d H:i|maintenance_end}}
- Duration: {{maintenance_duration}}
{{/if}}

{{#if contact_info}}
Contact Information:
{{#each contact_info}}
- {{this.role}}: {{this.name}} - {{this.email}}
{{/each}}
{{/if}}

Status URL: {{status_url}}
Alert ID: {{alert_id}} | {{current_datetime}}
    ',
    'variables' => [
        'alert_type', 'subject', 'priority', 'affected_systems', 
        'message', 'alert_id', 'status_url'
    ],
    'default_variables' => [
        'status_url' => 'https://status.sam.or.th'
    ],
    'supported_channels' => ['email', 'teams'],
    'priority' => 'high',
    'is_active' => true,
    'created_by' => 1
]);

echo "Alert template created with ID: " . $alertTemplate->id . "\n";
```

## 📧 API Testing Examples

### 2. List Available Templates

```bash
curl -X GET "http://localhost:8000/api/v1/templates" \
  -H "X-API-Key: sns_your-api-key-here" \
  -H "Content-Type: application/json"
```

### 3. Get Template Details

```bash
curl -X GET "http://localhost:8000/api/v1/templates/welcome-new-user" \
  -H "X-API-Key: sns_your-api-key-here"
```

### 4. Get Template Variables

```bash
curl -X GET "http://localhost:8000/api/v1/templates/welcome-new-user/variables" \
  -H "X-API-Key: sns_your-api-key-here"
```

### 5. Render Template (Preview)

```bash
curl -X POST "http://localhost:8000/api/v1/templates/welcome-new-user/render" \
  -H "X-API-Key: sns_your-api-key-here" \
  -H "Content-Type: application/json" \
  -d '{
    "variables": {
      "user_name": "John Doe",
      "user_email": "john.doe@sam.or.th",
      "department": "IT Department",
      "start_date": "2025-07-01",
      "is_manager": true,
      "next_steps": [
        "Complete HR orientation",
        "Set up your workstation",
        "Meet your team members",
        "Review department procedures"
      ],
      "login_url": "https://portal.sam.or.th/login"
    },
    "preview_only": true
  }'
```

### 6. Send Notification Using Template

```bash
curl -X POST "http://localhost:8000/api/v1/templates/welcome-new-user/send" \
  -H "X-API-Key: sns_your-api-key-here" \
  -H "Content-Type: application/json" \
  -d '{
    "recipients": ["john.doe@sam.or.th", "hr@sam.or.th"],
    "variables": {
      "user_name": "John Doe",
      "user_email": "john.doe@sam.or.th",
      "department": "IT Department",
      "start_date": "2025-07-01",
      "is_manager": true,
      "next_steps": [
        "Complete HR orientation",
        "Set up your workstation",
        "Meet your team members"
      ],
      "login_url": "https://portal.sam.or.th/login"
    },
    "channels": ["email"],
    "priority": "medium"
  }'
```

### 7. Send System Alert Using Template

```bash
curl -X POST "http://localhost:8000/api/v1/templates/system-alert/send" \
  -H "X-API-Key: sns_your-api-key-here" \
  -H "Content-Type: application/json" \
  -d '{
    "recipients": ["admin@sam.or.th", "it-team@sam.or.th"],
    "variables": {
      "alert_type": "Database Maintenance",
      "subject": "Scheduled Database Maintenance Tonight",
      "priority": "HIGH",
      "affected_systems": "Main Database, User Portal, Email System",
      "message": "We will be performing scheduled maintenance on our primary database server. During this time, some services may be temporarily unavailable.",
      "alert_id": "MAINT-2025-001",
      "is_urgent": false,
      "maintenance_window": true,
      "maintenance_start": "2025-06-17 22:00:00",
      "maintenance_end": "2025-06-18 02:00:00",
      "maintenance_duration": "4 hours",
      "contact_info": [
        {
          "role": "IT Manager",
          "name": "Jane Smith",
          "email": "jane.smith@sam.or.th"
        },
        {
          "role": "Database Admin",
          "name": "Bob Wilson",
          "email": "bob.wilson@sam.or.th"
        }
      ]
    },
    "channels": ["email", "teams"],
    "priority": "high"
  }'
```

## 🧪 Advanced Template Features Testing

### 8. Template with Complex Variables (Meeting Reminder)

```php
// สร้าง template ผ่าน Tinker
$meetingTemplate = App\Models\NotificationTemplate::create([
    'name' => 'Meeting Reminder',
    'category' => 'reminder',
    'slug' => 'meeting-reminder',
    'subject_template' => 'Reminder: {{meeting_title}} - {{date:M j, Y|meeting_date}}',
    'body_html_template' => '
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background: #2196F3; color: white; padding: 20px;">
                <h1>📅 Meeting Reminder</h1>
            </div>
            <div style="padding: 30px;">
                <h2>{{meeting_title}}</h2>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>📋 Meeting Details:</h3>
                    <p><strong>📅 Date:</strong> {{date:l, F j, Y|meeting_date}}</p>
                    <p><strong>🕐 Time:</strong> {{meeting_time}} ({{timezone}})</p>
                    <p><strong>⏱️ Duration:</strong> {{duration}} minutes</p>
                    <p><strong>📍 Location:</strong> {{location}}</p>
                    {{#if meeting_link}}
                    <p><strong>💻 Online:</strong> <a href="{{meeting_link}}">Join Meeting</a></p>
                    {{/if}}
                </div>
                
                {{#if agenda}}
                <h3>📝 Agenda:</h3>
                <ol>
                {{#each agenda}}
                    <li><strong>{{this.topic}}</strong> ({{this.duration}} min)
                        {{#if this.presenter}} - Presenter: {{this.presenter}}{{/if}}
                    </li>
                {{/each}}
                </ol>
                {{/if}}
                
                {{#if attendees}}
                <h3>👥 Attendees ({{attendees.length}}):</h3>
                <ul>
                {{#each attendees}}
                    <li>{{this.name}} {{#if this.required}}<span style="color: red;">*</span>{{/if}}</li>
                {{/each}}
                </ul>
                <p><small><span style="color: red;">*</span> Required attendee</small></p>
                {{/if}}
                
                {{#if preparation}}
                <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0;">
                    <h3>📚 Preparation Required:</h3>
                    <p>{{preparation}}</p>
                </div>
                {{/if}}
            </div>
        </div>
    ',
    'variables' => [
        'meeting_title', 'meeting_date', 'meeting_time', 'timezone', 
        'duration', 'location'
    ],
    'default_variables' => [
        'timezone' => 'UTC+7 (Bangkok)',
        'duration' => '60'
    ],
    'supported_channels' => ['email', 'teams'],
    'is_active' => true
]);
```

### 9. Test Complex Meeting Template

```bash
curl -X POST "http://localhost:8000/api/v1/templates/meeting-reminder/send" \
  -H "X-API-Key: sns_your-api-key-here" \
  -H "Content-Type: application/json" \
  -d '{
    "recipients": ["team@sam.or.th"],
    "variables": {
      "meeting_title": "Q2 Planning Meeting",
      "meeting_date": "2025-06-20",
      "meeting_time": "10:00 AM",
      "duration": 90,
      "location": "Conference Room A / Teams",
      "meeting_link": "https://teams.microsoft.com/join/meeting123",
      "agenda": [
        {
          "topic": "Q1 Review",
          "duration": "20",
          "presenter": "Jane Smith"
        },
        {
          "topic": "Q2 Goals & Objectives",
          "duration": "30",
          "presenter": "John Doe"
        },
        {
          "topic": "Budget Discussion",
          "duration": "25"
        },
        {
          "topic": "Q&A Session",
          "duration": "15"
        }
      ],
      "attendees": [
        {"name": "Jane Smith", "required": true},
        {"name": "John Doe", "required": true},
        {"name": "Bob Wilson", "required": false},
        {"name": "Alice Johnson", "required": true}
      ],
      "preparation": "Please review the Q1 performance report and prepare your Q2 objectives before the meeting."
    }
  }'
```

## 🔍 Template Management Commands

### 10. Template Validation and Testing via Tinker

```php
php artisan tinker

// Test template validation
$template = App\Models\NotificationTemplate::find(1);
$errors = $template->validateTemplate();
if (!empty($errors)) {
    dd($errors);
} else {
    echo "Template is valid!\n";
}

// Test variable extraction
$variables = $template->extractVariables();
dd($variables);

// Test template rendering with sample data
$preview = $template->preview([
    'user_name' => 'Test User',
    'company' => 'Test Company'
]);
echo $preview['subject'] . "\n";
echo $preview['body_text'] . "\n";

// Get template usage statistics
$stats = [
    'total_notifications' => $template->notifications()->count(),
    'recent_usage' => $template->notifications()->where('created_at', '>=', now()->subDays(30))->count(),
    'last_used' => $template->notifications()->latest()->first()?->created_at
];
dd($stats);
```

## 📊 Monitoring Template Usage

### 11. Check Template Performance

```bash
# Get template categories
curl -X GET "http://localhost:8000/api/v1/templates/categories" \
  -H "X-API-Key: sns_your-api-key-here"

# List templates by category
curl -X GET "http://localhost:8000/api/v1/templates?category=welcome&active_only=true" \
  -H "X-API-Key: sns_your-api-key-here"

# Get template usage in Telescope
# Visit: http://localhost:8000/telescope
# Filter by: "template" in requests
```

## 🎯 Best Practices for Template Usage

### 12. Template Variable Naming Conventions

```json
{
  "user_variables": {
    "user_name": "Full name",
    "user_email": "Email address", 
    "user_first_name": "First name only",
    "user_department": "Department name"
  },
  "system_variables": {
    "app_name": "Application name",
    "current_date": "Current date",
    "current_time": "Current time"
  },
  "content_variables": {
    "subject": "Custom subject",
    "message": "Main message content",
    "url": "Action URL",
    "deadline": "Important deadline"
  },
  "conditional_variables": {
    "is_urgent": "Boolean for urgent content",
    "is_manager": "Boolean for manager-specific content",
    "has_attachment": "Boolean for attachment presence"
  },
  "array_variables": {
    "items": "List of items",
    "attendees": "List of people",
    "agenda": "Meeting agenda items"
  }
}
```

---

## 🚀 Ready to Use Templates!

ตอนนี้ระบบ template พร้อมใช้งานแล้ว สามารถ:
- สร้าง templates ที่ซับซ้อนด้วย variables และ conditionals
- ส่ง notifications ผ่าน API โดยใช้ templates
- Render templates แบบ preview ก่อนส่งจริง
- จัดการ templates ผ่าน web interface และ API
- Monitor การใช้งาน templates

Template system นี้จะทำให้การส่ง notifications มีประสิทธิภาพและสามารถ maintain ได้ง่ายขึ้นมากครับ! 🎉